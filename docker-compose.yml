version: '3.8'

services:
  # 向量数据库 Qdrant
  qdrant:
    image: qdrant/qdrant:latest
    container_name: hias_bot_qdrant
    ports:
      - "6333:6333" # HTTP API
      - "6334:6334" # gRPC API
    volumes:
      - ./data/qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/readyz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 图数据库 Neo4j
  neo4j:
    image: neo4j:5.19.0
    container_name: hias_bot_neo4j
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    volumes:
      - ./data/neo4j_data:/data
      - ./data/neo4j_logs:/logs
      - ./data/neo4j_import:/var/lib/neo4j/import
      - ./data/neo4j_plugins:/plugins
    environment:
      # 默认账号密码，请在 .env 中修改或生产环境中更改
      # 注意：这里的密码需要与 bot 服务中的 NEO4J_PASSWORD 保持一致
      # database_config.py 中默认密码为 12345678
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/12345678}
      # 内存配置建议
      - NEO4J_dbms_memory_pagecache_size=512M
      - NEO4J_dbms_memory_heap_initial_size=512M
      - NEO4J_dbms_memory_heap_max_size=1G
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 机器人服务
  bot:
    image: ghcr.io/tbjuechen/hias-bot:latest
    # build: .
    container_name: hias_bot
    volumes:
      - ./data/botdata:/app/data
      - ./.env:/app/.env
    environment:
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_VECTOR_SIZE=4096
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=12345678
    depends_on:
      qdrant:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    restart: unless-stopped
    # 保持容器运行，方便调试
    tty: true
    stdin_open: true

networks:
  default:
    name: hias_bot_network
